#!/bin/bash

rewrite() {
    cat $1 | \
	sed \
	    -e "s#@ZOOKEEPERS@#${ZOOKEEPERS}#" \
	    -e "s#@HDFS_VOLUMES@#${HDFS_VOLUMES}#" \
	    > $1.tmp
    mv $1.tmp $1
}

ZOOKEEPERS=${ZOOKEEPERS:-zookeeper:2181}
MY_HOSTNAME=${MY_HOSTNAME:-localhost}
HDFS_VOLUMES=${HDFS_VOLUMES:-hdfs://hadoop:9000/accumulo}

rewrite ${ACCUMULO_HOME}/conf/accumulo-site.xml

if [ ! -f /accumulo/.init.accumulo ]
then
    echo 'Initialise accumulo...'
    /usr/local/accumulo/bin/accumulo init --instance-name accumulo --password accumulo
    mkdir -p /data
    touch /accumulo/.init.accumulo
fi

(
    for v in $(echo ${GC_HOSTS} | sed 's/,/ /g')
    do
	echo $v
    done
) > /usr/local/accumulo/conf/gc

(
    for v in $(echo ${MASTER_HOSTS} | sed 's/,/ /g')
    do
	echo $v
    done
) > /usr/local/accumulo/conf/masters

(
    for v in $(echo ${SLAVE_HOSTS} | sed 's/,/ /g')
    do
	echo $v
    done
) > /usr/local/accumulo/conf/slaves

(
    for v in $(echo ${MONITOR_HOSTS} | sed 's/,/ /g')
    do
	echo $v
    done
) > /usr/local/accumulo/conf/monitor

(
    for v in $(echo ${TRACER_HOSTS} | sed 's/,/ /g')
    do
	echo $v
    done
) > /usr/local/accumulo/conf/tracers

(
    for v in $(echo ${DAEMONS} | sed 's/,/ /g')
    do
	echo Starting $v...
	/usr/local/accumulo/bin/start-daemon.sh ${MY_HOSTNAME} $v
    done
)

while true
do
    sleep 100000
done

